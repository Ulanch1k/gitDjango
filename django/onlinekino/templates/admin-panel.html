<html  xmlns:th="http://www.thymeleaf.org" lang="ru">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js" integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI=" crossorigin="anonymous"></script>

        <title>Admin menu</title>
    </head>
    <body>
     <div class="container">
         <div class="row mt-5">
             <div class="col-6 offset-3">
                 <form method="post">
                     {% csrf_token %}
                     <div class="form-group">
                         <label>
                             Title:
                         </label>
                         <input type="text" class="form-control" name="item_name" id="txt1">
                     </div>
                     <div class="form-group">
                         <label>
                             Description:
                         </label>
                         <input type="text" class="form-control" name="item_memory" id="txt2">
                     </div>
                     <div class="form-group">
                         <label>
                             Rating:
                         </label>
                         <input type="number" value="0" max="1000000" class="form-control" name="item_price" id="num">
                     </div>
                     <div class="form-group">
                         <label>
                             Genres:
                         </label>
                         <input type="text" class="form-control" name="item_color">
                     </div>
                     <div class="form-group">
                         <input type="submit" id="sbm">
                     </div>
                 </form>
             </div>
         </div>
         <div class="row mt-5">
             <div class="col-12">
                 <table class="table table-striped">
                     <thead>
                     <tr>
                         <th>Title</th>
                         <th>Rating</th>
                         <th>Description</th>
                         <th>Release</th>
                         <th>Genres</th>
                     </tr>
                     </thead>
                     <tbody id="main_tb">

                     </tbody>
                 </table>
             </div>
         </div>
     </div>

     <script>
            function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

		let send_data = document.getElementById('sbm');
        send_data.addEventListener('click', function (){
            console.log('Начало')
			let title = document.getElementById('txt1').value;
			let description = document.getElementById('txt2').value;
			let rating = document.getElementById('num').value;
			const url = 'http://127.0.0.1:8000/api/movies/';
            let headers = {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            };
            let body = {
				'title': title,
	            'description': description,
	            'rating': rating,
            };
            let options = {
                method: 'POST',
	            headers: headers,
	            body: JSON.stringify(body)
            };
            fetch(url, options).then(
                response => {
                    if (response.ok){
                        alert('Фильм в базе данных');
                    }
                }
            )
	        document.location.reload();
        });
        window.addEventListener('load', function () {
              const url = 'http://127.0.0.1:8000/api/movies/';
              let headers = {
                  'Content-Type': 'application/json'
              }
              let option = {
                  method: 'GET',
                  headers: headers
              };
              fetch(url, option)
                  .then(response => response.json())
                  .then(result => {
                      console.log(result)
                      for (let n = 0; n < result.length; n++) {
                          console.log(result[n].title)
                          let tb = document.getElementById('main_tb')
                          let tr = document.createElement('tr')
                          let td = document.createElement('td')
                          tb.appendChild(tr)
                          tr.appendChild(td).className = "first_td"
                          td.innerText = result[n].title
                      }
                      for (let n = 0; n < result.length; n++){
                          let tb = document.getElementById('main_tb')
                          let tr = document.createElement('tr')
                          let td = document.createElement('td')

                          td.innerText = result[n].rating
                      }
                  })
          });
     </script>
    </body>
</html>